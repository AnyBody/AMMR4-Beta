/// Morhping GM foot to TLEM foot
AnyFolder InterfaceMorphingDef = {
  /// Mirroring about XY plane
  AnyMatrix MirroringMat ={ {1,0,0},{0,1,0},{0,0,...Sign} };
  /// Manually picked points on unscaled foot
  AnyMatrix IM_PickedPoints_GMFoot_Unscaled = {
{-0.01923199, 0.08287545, -0.005511518}, 
{-0.01524367, -0.03055783, 0.04927201}, 
{-0.007463424, -0.06155794, 0.01020253}, 
{-0.01293344, -0.05830658, -0.01899186}, 
{-0.007135777, 0.08833511, 0.02071268}, 
{0.02138242, 0.1071969, -0.008062809}, 
{0.02375501, 0.02864095, -0.0233577}, 
{0.03208032, 0.06022059, -0.02273428}, 
{0.05175828, 0.02216302, -0.00340573}, 
{-0.005682771, 0.02788353, 0.03648632}, 
{0.003680642, -0.06619624, 0.02785669}, 
{-7.461739e-05, -0.1235624, 0.002615576}, 
{-0.005960456, -0.1209222, 0.02216102}, 
{-0.01315969, -0.07711031, 0.05734278}, 
{0.004153599, -0.1015452, -0.007942333}, 
{0.01403757, -0.06886744, -0.01411949}, 
{-0.005503197, -0.1074323, -0.01630258}, 
{-0.008881217, -0.05529472, -0.004441717}, 
{0.004741706, -0.009375548, -0.005258739}, 
{0.03247751, -0.02414269, -0.003396478}, 
{0.01269824, -0.03913711, 0.02443971}, 
{0.002571291, -0.01204249, 0.04770501}, 
{-0.01079895, -0.04915066, 0.03774491}, 
{0.002197147, -0.09023196, 0.03133562}, 
{-0.005145356, -0.08897588, 0.03108988}, 
{-0.008576392, -0.07615147, -0.01565496}, 
{-0.002743212, -0.03913682, 0.05575598}, 
{-0.00363709, 0.1079017, 0.01250168}
//{0.0449248, 0.07027722, 0.02751965}, //Lat Mal
//{0.0553215, 0.06030982, -0.02834151} // Med Mal
}*MirroringMat;
  /// Manually picked points on unscaled foot
  AnyMatrix IM_PickedPoints_TLEMFoot_Unscaled = {
{-0.02130102, -0.03769134, -0.008233341}, 
{0.1050721, -0.04453817, 0.03245867}, 
{0.1222212, -0.03878504, -0.0002568579}, 
{0.1292807, -0.04402486, -0.02382537}, 
{-0.01380033, -0.02898138, 0.02019412}, 
{-0.03260353, -0.001598987, -0.008218175}, 
{0.03070482, -0.008148696, -0.03136819}, 
{0.008430794, 0.003214434, -0.02903448}, 
{0.04368711, 0.0177882, -0.0161216}, 
{0.03992446, -0.02796289, 0.0270921}, 
{0.1277736, -0.02817444, 0.01225129}, 
{0.1871869, -0.04951122, -0.003472061}, 
{0.1796889, -0.04722395, 0.01572011}, 
{0.1506876, -0.04438514, 0.04146769}, 
{0.1665657, -0.0326672, -0.01219934}, 
{0.1310539, -0.02285874, -0.0193953}, 
{0.1701887, -0.04386451, -0.02228445}, 
{0.1240674, -0.04484852, -0.01282732}, 
{0.07022157, -0.02648028, -0.01536114}, 
{0.08792123, 0.0001222242, -0.01682986}, 
{0.1002694, -0.01511084, 0.0100659}, 
{0.08213602, -0.02599641, 0.03109123}, 
{0.1153041, -0.0429172, 0.01840446}, 
{0.1537493, -0.03646047, 0.01777933}, 
{0.1507629, -0.04135209, 0.01803696}, 
{0.1375508, -0.04119601, -0.02094636}, 
{0.110342, -0.03273024, 0.03341644}, 
{-0.03705186, -0.02087882, 0.01151878}
//{-0.02295, 0.02568, 0.02186}, //LatMal
//{0.01085, 0.03585, -0.03351} //MedMal
}*MirroringMat;
  
// AnyMatrix IM_PickedPoints_GMFoot_Unscaled = {
//    {-0.01961456, 0.0858648, -0.007123132}, 
//    {0.02075712, 0.1087559, -0.006255695}, 
//    {0.0342384, 0.05814035, -0.02207076}, 
//    {0.02573188, 0.0293713, -0.02425312}, 
//    {0.05192875, 0.02385391, -0.002496652}, 
//    {-0.005725655, 0.0278952, 0.03647349}, 
//    {0.008851912, -0.07466774, -0.01443108}, 
//    {-0.007507085, -0.07433279, -0.01176224}, 
//    {0.0004892429, -0.1238552, 0.001978389}, 
//    {-0.01497396, -0.04175921, 0.05853032}, 
//    {0.03469826, -0.009105483, 0.01519154}, 
//    {0.004084765, -0.01045513, -0.006703559}
//  }*MirroringMat;
//  /// Manually picked points on unscaled foot
//  AnyMatrix IM_PickedPoints_TLEMFoot_Unscaled = {
//    {-0.02252427, -0.03790143, -0.008338326}, 
//    {-0.03461374, -0.002309684, -0.009032215}, 
//    {0.009918688, 0.002448009, -0.02865508}, 
//    {0.0307748, -0.00828098, -0.03138046}, 
//    {0.04263911, 0.01830755, -0.01265807}, 
//    {0.03993737, -0.02786064, 0.02709521}, 
//    {0.1383494, -0.0259056, -0.02061057}, 
//    {0.1372951, -0.04079262, -0.01777501}, 
//    {0.1869549, -0.04883619, -0.002536982}, 
//    {0.1139123, -0.04244486, 0.0392754}, 
//    {0.07316664, 0.006129127, -0.00285548}, 
//    {0.07007261, -0.02680092, -0.01598569}
//  }*MirroringMat;

  
  /// Affine transformation of GM foot to Tlem foot
  AnyFunTransform3DLin2 IM_Foot_GM_To_TLEM_Affine = {
    Points0 = .IM_PickedPoints_GMFoot_Unscaled;
    Points1 = .IM_PickedPoints_TLEMFoot_Unscaled;
    Mode = VTK_LANDMARK_AFFINE;
  };
  /// RBF Transform of GM foot to Tlem foot using affine
  /// transformation as pretransform
  AnyFunTransform3DRBF IM_FootAffine_GM_To_TLEM_RBF = {
    Points0 = .IM_PickedPoints_GMFoot_Unscaled;
    Points1 = .IM_PickedPoints_TLEMFoot_Unscaled;
    PreTransforms = {&.IM_Foot_GM_To_TLEM_Affine};
    
    RBFDef.Type = RBF_ThinPlate;
    BoundingBoxOnOff = On;
    BoundingBox.ScaleXYZ = {1,1,1}*2;
    BoundingBox.DivisionFactorXYZ = {1, 1, 1}*2;
    BoundingBox.Type = BB_PrincipalAxes;
  };
//  /// Reverse rigid body transformation from TLEM to GM foot
//  AnyFunTransform3DLin2 IM_Foot_TLEM_To_GM_RigidBody = {
//    Points0 = .IM_PickedPoints_TLEMFoot_Unscaled;
//    Points1 = .IM_PickedPoints_GMFoot_Unscaled;
//    Mode = VTK_LANDMARK_RIGIDBODY;
//  };
  /// Interface morphing of GM foot to Tlem foot including reverse transformation
  AnyFunTransform3DLin IM_Foot_GM_To_TLEM = {
    PreTransforms = {&.IM_FootAffine_GM_To_TLEM_RBF};//, &.IM_Foot_TLEM_To_GM_RigidBody};
    ScaleMat = {{1,0,0},{0,1,0},{0,0,1}};
    Offset = {0,0,0};
  };

};// Interface Morphing

AnyFunTransform3D& GeomScale = ..GeoScaling.Foot.ScaleFunction;

#if BM_SCALING == _SCALING_NONE_
InterfaceMorphingDef = {
  /// Rigid transformation of GM foot to Tlem foot
  AnyFunTransform3DLin2 IM_Foot_GM_To_TLEM_Rigidbody = {
    Points0 = .IM_PickedPoints_GMFoot_Unscaled;
    Points1 = .IM_PickedPoints_TLEMFoot_Unscaled;
    Mode = VTK_LANDMARK_RIGIDBODY;
  };
};
AnyFunTransform3D Scale = {
  PreTransforms = {&.InterfaceMorphingDef.IM_Foot_GM_To_TLEM_Rigidbody};
};
#else
/// Scale function consisting of interface morphing and anthropometric scaling
AnyFunTransform3D Scale = {
  PreTransforms = {&.InterfaceMorphingDef.IM_Foot_GM_To_TLEM,
                   &.GeomScale};
};
#endif

Scale = {
  AnyFunTransform3DLin &T0 = .Scale;
};

AnyFolder &ModelParameters = ..ModelParameters;
//ModelParameters.Foot = {
//  
//  AnyMatrix IM_PickedPoints_GMFoot_Unscaled = {
//    {-0.01961456, 0.0858648, -0.007123132}, 
//    {0.02075712, 0.1087559, -0.006255695}, 
//    {0.0342384, 0.05814035, -0.02207076}, 
//    {0.02573188, 0.0293713, -0.02425312}, 
//    {0.05192875, 0.02385391, -0.002496652}, 
//    {-0.005725655, 0.0278952, 0.03647349}, 
//    {0.008851912, -0.07466774, -0.01443108}, 
//    {-0.007507085, -0.07433279, -0.01176224}, 
//    {0.0004892429, -0.1238552, 0.001978389}, 
//    {-0.01497396, -0.04175921, 0.05853032}, 
//    {0.03469826, -0.009105483, 0.01519154}, 
//    {0.004084765, -0.01045513, -0.006703559}
//  };
//  
//  AnyMatrix IM_PickedPoints_TLEMFoot_Unscaled = {
//    {-0.02252427, -0.03790143, -0.008338326}, 
//    {-0.03461374, -0.002309684, -0.009032215}, 
//    {0.009918688, 0.002448009, -0.02865508}, 
//    {0.0307748, -0.00828098, -0.03138046}, 
//    {0.04263911, 0.01830755, -0.01265807}, 
//    {0.03993737, -0.02786064, 0.02709521}, 
//    {0.1383494, -0.0259056, -0.02061057}, 
//    {0.1372951, -0.04079262, -0.01777501}, 
//    {0.1869549, -0.04883619, -0.002536982}, 
//    {0.1139123, -0.04244486, 0.0392754}, 
//    {0.07316664, 0.006129127, -0.00285548}, 
//    {0.07007261, -0.02680092, -0.01598569}
//  };
//  
//};





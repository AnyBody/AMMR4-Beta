
AnyFolder Model = {
  // Model parts included in the moment arm study
  AnyFolder &PelvisRef = .TrunkHumanFolderRef.SegmentsLumbar.PelvisSeg; 
  AnyFolder &TrunkRef = .TrunkHumanFolderRef; 
  #if BM_TRUNK_MUSCLES
  AnyFolder &SpineMusRef = .TrunkHumanFolderRef.MusclesSpine;
  AnyFolder &SpineMusRightRef =. TrunkHumanFolderRef.MusclesSpineRight;
  AnyFolder &SpineMusLeftRef = .TrunkHumanFolderRef.MusclesSpineLeft;
  #else
  AnyFolder SpineMusRef = {};
  AnyFolder SpineMusRightRef = {};
  AnyFolder SpineMusLeftRef = {};
  #endif
  
  
  
  
 AnyFixedRefFrame ground = {
   AnyRefNode node = { 
      ARel=..PelvisRef.Axes0;
     sRel=..PelvisRef.r0;
   };
 };
 
// #if BM_ARM_RIGHT
// AnyFolder& RightArmRef = ....BodyModel.Right.ShoulderArm;
//  AnyKinEq RHipDriver= {
//  };
// 
// 
// #endif
 

AnyFolder Drivers = {
   AnyVar AngularVelocity = (..RangeOfMotion[1]-..RangeOfMotion[0])*pi/180;
 
 AnyKinMeasureOrg TrunkMeasure = {
  AnyKinMeasure &PelvisThoraxExtension= ...TrunkHumanInterfaceRef.PelvisThoraxExtension;
  AnyKinMeasure &PelvisThoraxLateralBending= ...TrunkHumanInterfaceRef.PelvisThoraxLateralBending;
  AnyKinMeasure &PelvisThoraxRotation= ...TrunkHumanInterfaceRef.PelvisThoraxRotation;
  AnyKinMeasure &SkullThoraxFlexion= ...TrunkHumanInterfaceRef.SkullThoraxFlexion;
  AnyKinMeasure &SkullThoraxLateralBending= ...TrunkHumanInterfaceRef.SkullThoraxLateralBending;
  AnyKinMeasure &SkullThoraxRotation= ...TrunkHumanInterfaceRef.SkullThoraxRotation;
 };
   
 
 // If Leg are included then Psoas muscle are attached to the legs. 
 // Thus, we need to driver for the hip joint
 #if BM_LEG_RIGHT
 AnySphericalJoint &RHipJoint = .....BodyModel.Right.Leg.Jnt.Hip;
 AnyKinEq RHipDriver= {
   AnyKinMeasureOrg HipMeasure = {
      AnyKinMeasure &ref1 = .......BodyModel.Interface.Right.HipFlexion;
      AnyKinMeasure &ref2 = .......BodyModel.Interface.Right.HipAbduction;
      AnyKinMeasure &ref3 = .......BodyModel.Interface.Right.HipExternalRotation;
    };
  };
 #endif
 #if BM_LEG_LEFT
 AnySphericalJoint &LHipJoint = .....BodyModel.Left.Leg.Jnt.Hip;
 AnyKinEq LHipDriver= {
   AnyKinMeasureOrg HipMeasure = {
      AnyKinMeasure &ref1 = .......BodyModel.Interface.Left.HipFlexion;
      AnyKinMeasure &ref2 = .......BodyModel.Interface.Left.HipAbduction;
      AnyKinMeasure &ref3 = .......BodyModel.Interface.Left.HipExternalRotation;
    };
  };
 #endif
 
 
 AnyStdJoint PelvisGround={
    AnyRefFrame &Ground = ..ground.node;
    AnyRefFrame &Sacrum= ..PelvisRef; 
 };
    
   };// Drivers
   
  AnyForce JointLoad = {
      AnyKinMeasure &ref = .Drivers.TrunkMeasure;
      AnyInt Sign = -round(.Drivers.AngularVelocity/abs(.Drivers.AngularVelocity));
      F = 50*Sign*not(not(.Drivers.TrunkDriver.DriverVel));
  };   
 
};
 
 
AnyBodyStudy Study = {
  Gravity = {0,0,0};
//  tStart = 0;
  tEnd = 1;
  #ifdef EVALUATE_JOINT_STRENGTH_NSTEP
  nStep = EVALUATE_JOINT_STRENGTH_NSTEP;
  #else
  nStep = 40;
  #endif
    
//  InitialConditions.KinematicTol = 1e-5;
//  InitialConditions.MaxIteration = 5000;
//  InitialConditions.SolverType = KinSolDeterminate2;
//  
//  Kinematics.KinematicTol = 1e-3;
//  Kinematics.MaxIteration = 5000;
//  Kinematics.SolverType = KinSolDeterminate2;

  
  Kinematics.UseStartGuessOnOff = On;
  Kinematics.PosAnalysisOnlyOnOff = Off;
  InitialConditions.PosAnalysisOnlyOnOff = Off;

  InverseDynamics.Criterion.Type = MR_MinMaxStrict;
  
  AnyFolder &Model = .Model;
    
  AnyFolder JointStrength = {
     AnyFolder Abscissa  ={
        AnyVar JointAngle = not(not(..Model.Drivers.TrunkDriver.DriverVel))*..Model.Drivers.TrunkMeasure.Pos'*180/pi;     
     };
     AnyVar JointStrength = max(abs(.Model.JointLoad.F))/(.MaxMuscleActivity+0.00000001);
     
     //AnyVar PsoasMajorT12I = -1*.Model.SpineMusRef.PsoasMajor.PMT12I_TM.LmtDot/.Model.Drivers.AngularVelocity;
  };
  
  
  
  
  

};

#if (ANYBODY_V1 >= 6) & (ANYBODY_V2 >= 1)
AnyFolder ModelViews = { AnyFolder Views =  {}; };
#else
AnyProject ModelViews = {};
#endif

ModelViews = {
  AnyDrawGroup Selection = {
    Objects = arrcat(arrcat(arrcat(arrcat(
                     ObjSearchRecursive(CompleteNameOf(&..Model.PelvisRef ), "*", "AnyDrawObject"), 
                     ObjSearchRecursive(CompleteNameOf(&..Model.TrunkRef ), "*", "AnyDrawObject")),
                     ObjSearchRecursive(CompleteNameOf(&..Model.SpineMusRef ), "*", "AnyDrawObject")),
                     ObjSearchRecursive(CompleteNameOf(&..Model.SpineMusRightRef ), "*", "AnyDrawObject")),
                     ObjSearchRecursive(CompleteNameOf(&..Model.SpineMusLeftRef ), "*", "AnyDrawObject"));
  };
  Views = {
    AnyProjectModelViewDefinition SelectedView = {
      DrawGroupSequence = {&..Selection};
      Reset = {On};
    };
  };
};

AnyOperationSequence Run = 
{
    AnyOperationMacro SetView = 
    {
      MacroStr = { "classoperation " + CompleteNameOf(&..ModelViews.Views.SelectedView) + strquote("Set View") };
    };
    AnyOperation &Study = .Study.Kinematics;
//    #ifdef ANYBODY_PATH_OUTPUT
//    AnyOperationMacro Save = 
//    {
//      MacroStr = {
//           "classoperation " + CompleteNameOf(&.Study.Output) + strquote("Save data") 
//           + " --type=" + strquote("Deep") +" --file=" + strquote(
//           ANYBODY_PATH_OUTPUT + .OutputFileName + ".anydata.h5")
//      };
//    #endif
};